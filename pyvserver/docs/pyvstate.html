<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>pyvstate API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>pyvstate</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#!/usr/bin/env python

from __future__ import print_function

from Crypto.Hash import SHA512
import os, sys, getopt, signal, select, string, time, stat, base64
import inspect, multiprocessing

try:
    import fcntl
except:
    fcntl = None

import pyvpacker

import pyservsup, pyclisup, support
import crysupp, pysyslog, pywrap

from pyvfunc import *

# Ping pong state machine

# 1.) States

initial     = 0
auth_akey   = 1
auth_sess   = 2
auth_user   = 3
auth_key    = 4
auth_pass   = 5
auth_twofa  = 6
in_idle     = 7
got_fname   = 8
in_trans    = 9
got_file    = 10

# The commands in this state are allowed always
all_in       = 100

# The commands in this state are allowed in all states after auth
auth_in      = 110

# The commands in this state do not set new state
none_in      = 120

# ------------------------------------------------------------------------
# Help stings

usage = &#34;Usage:&#34;
user_help   = usage + &#34; user logon_name -- set session user name&#34;
akey_help   = usage + &#34; akey -- get asymmetric key&#34;
pass_help   = usage + &#34; pass logon_pass -- password&#34;
chpass_help = usage + &#34; chpass user  oldpass, newpass&#34;
file_help   = usage + &#34; file fname -- Specify name for upload&#34;
mkdir_help  = usage + &#34; mkdir dirname -- Specify name for new dir&#34;
rmdir_help  = usage + &#34; rmdir dirname -- Specify dir name to delete&#34;
fget_help   = usage + &#34; fget fname -- Download (get) file&#34;
fput_help   = usage + &#34; fput fname -- Upload (put) file&#34;
del_help    = usage + &#34; del  fname -- Delete file&#34;
uadd_help   = usage + &#34; uadd user_name user_pass -- Create new user&#34;
uini_help   = usage + &#34; uini user_name user_pass -- Create initial user. Loopback only.&#34;
uena_help   = usage + &#34; uena user_name  flag -- enable / disable user&#34;
ulist_help  = usage + &#34; ulist flag  -- list users. Flag: user / admin / initial / disabled&#34;
aadd_help   = usage + &#34; aadd user_name user_pass -- create admin user&#34;
udel_help   = usage + &#34; udel user_name -- Delete user&#34;
data_help   = usage + &#34; data datalen -- Specify length of file to follow&#34;
vers_help   = usage + &#34; ver -- Get server version.&#34;
id_help     = usage + &#34; id -- Get site id string&#34;
hello_help  = usage + &#34; hello -- Say Hello - test connectivity.&#34;
quit_help   = usage + &#34; quit -- Terminate connection. alias: exit&#34;
exit_help   = usage + &#34; exit -- Terminate connection. alias: quit&#34;
help_help   = usage + &#34; help [command] -- Offer help on command&#34;
lsls_help   = usage + &#34; ls [dir] -- List files in dir&#34;
lsld_help   = usage + &#34; lsd [dir] -- List dirs in dir&#34;
cdcd_help   = usage + &#34; cd dir -- Change to dir. Capped to server root&#34;
pwdd_help   = usage + &#34; pwd -- Show current dir&#34;
tout_help   = usage + &#34; tout [val] -- Get / Set timeout value. (seconds)&#34;
ekey_help   = usage + &#34; ekey encryption_key -- Set encryption key &#34;
sess_help   = usage + &#34; sess session data -- Start session &#34;
logout_help = usage + &#34; logout -- log out user&#34;
buff_help   = usage + &#34; buff buff_size -- limited to 64k&#34;
throt_help  = usage + &#34; throt flag -- turn on or off throttling&#34;
rput_help   = usage + &#34; rcheck kind link | sum -- check records. Link check or sum check&#34;
rtest_help  = usage + &#34; rtest link | sum recids -- check a list of records. Link check or sum check&#34;
rcheck_help = usage + &#34; rput kind header, [field1, field2] ... -- put record in blockchain.&#34;
rlist_help  = usage + &#34; rlist kind beg_date end_date -- get records from blockchain.&#34;
rcount_help = usage + &#34; rcount kind beg_date end_date -- get record count from blockchain.&#34;
rsize_help  = usage + &#34; rsize kind -- get total record count from blockchain.&#34;
rget_help   = usage + &#34; rget kind header -- get record from blockchain.&#34;
rabs_help   = usage + &#34; rabs kind pos -- get record by absolute position from blockchain.&#34;
rhave_help  = usage + &#34; rhave kind header -- is record in blockchain.&#34;

qr_help     = usage + &#34; qr -- get QR code image for 2fa&#34;
twofa_help  = usage + &#34; twofa pass -- two factor authentication credentials&#34;
dmode_help  = usage + &#34; dmode -- get current dmode (Developer Mode) flag&#34;
ihave_help  = usage + &#34; ihave -- &#39;i have you have&#39; protocol entry point&#34;
ihost_help  = usage + &#34; ihost -- add / delete replicator host:port target&#34;
stat_help   = usage + &#34; stat fname  -- Get file stat&#34;
xxxx_help   = usage + &#34; no data -- Template for new help&#34;

# ------------------------------------------------------------------------
# Table driven server state machine.
# The table is searched for a mathing start_state, and the corresponding
# function is executed. The new state set to end_state

def init_state_table():

    global state_table
    #print(&#34;pystate init table&#34;)
    # This is to develop without entering auth code every time
    if not pyservsup.globals.conf.pmode:
        minauth =  auth_pass
    else:
        minauth =  auth_twofa

    state_table = \
    [
        # Command; start_state; end_state; min_auth; action func;  help func
        (&#34;ver&#34;,     all_in,  none_in,    initial,   get_ver_func,     vers_help),
        (&#34;id&#34;,      all_in,  none_in,    initial,   get_id_func,      id_help),
        (&#34;hello&#34;,   all_in,  none_in,    initial,   get_hello_func,   hello_help),
        (&#34;helo&#34;,    all_in,  none_in,    initial,   get_hello_func,   hello_help),
        (&#34;quit&#34;,    all_in,  none_in,    initial,   get_exit_func,    quit_help),
        (&#34;exit&#34;,    all_in,  none_in,    initial,   get_exit_func,    exit_help),
        (&#34;help&#34;,    all_in,  none_in,    initial,   get_help_func,    help_help),
        (&#34;akey&#34;,    all_in,  none_in,    initial,   get_akey_func,    akey_help),
        (&#34;uini&#34;,    all_in,  none_in,    initial,   get_uini_func,    uini_help),
        (&#34;user&#34;,    all_in,  none_in,    initial,   get_user_func,    user_help),
        (&#34;pass&#34;,    all_in,  auth_pass,  initial,   get_pass_func,    pass_help),
        (&#34;logout&#34;,  all_in,  initial,    auth_pass, get_lout_func,    logout_help),
        (&#34;sess&#34;,    all_in,  none_in,    initial,   get_sess_func,    sess_help),
        (&#34;tout&#34;,    all_in,  none_in,    initial,   get_tout_func,    tout_help),
        (&#34;qr&#34;,      all_in,  none_in,    initial,   get_qr_func,      qr_help),
        (&#34;chpass&#34;,  all_in,  none_in,    auth_pass, get_chpass_func,  chpass_help),
        (&#34;file&#34;,    all_in,  none_in,    auth_pass, put_file_func,    file_help),
        (&#34;mkdir&#34;,   all_in,  none_in,    auth_pass, get_mkdir_func,   mkdir_help),
        (&#34;rmdir&#34;,   all_in,  none_in,    auth_pass, get_rmdir_func,   rmdir_help),
        (&#34;data&#34;,    all_in,  none_in,    auth_pass, put_data_func,    data_help),
        (&#34;fget&#34;,    all_in,  none_in,    auth_pass, get_fget_func,    fget_help),
        (&#34;fput&#34;,    all_in,  none_in,    auth_pass, get_fput_func,    fput_help),
        (&#34;del&#34;,     all_in,  none_in,    auth_pass, get_del_func,     del_help),
        (&#34;uadd&#34;,    all_in,  none_in,    auth_pass, get_uadd_func,    uadd_help),
        (&#34;udel&#34;,    all_in,  none_in,    auth_pass, get_udel_func,    udel_help),
        (&#34;uena&#34;,    all_in,  none_in,    auth_pass, get_uena_func,    uena_help),
        (&#34;ulist&#34;,   all_in,  none_in,    auth_pass, get_ulist_func,   ulist_help),
        (&#34;aadd&#34;,    all_in,  none_in,    auth_pass, get_aadd_func,    aadd_help),
        (&#34;ls&#34;,      all_in,  none_in,    auth_pass, get_ls_func,      lsls_help),
        (&#34;dir&#34;,     all_in,  none_in,    auth_pass, get_ls_func,      lsls_help),
        (&#34;lsd&#34;,     all_in,  none_in,    auth_pass, get_lsd_func,     lsld_help),
        (&#34;cd&#34;,      all_in,  none_in,    auth_pass, get_cd_func,      cdcd_help),
        (&#34;pwd&#34;,     all_in,  none_in,    auth_pass, get_pwd_func,     pwdd_help),
        (&#34;stat&#34;,    all_in,  none_in,    auth_pass, get_stat_func,    stat_help),
        (&#34;buff&#34;,    all_in,  none_in,    auth_pass, get_buff_func,    buff_help),
        (&#34;throt&#34;,   all_in,  none_in,    auth_pass, get_throt_func,   throt_help),
        (&#34;twofa&#34;,   all_in,  auth_twofa, auth_pass, get_twofa_func,   twofa_help),
        (&#34;dmode&#34;,   all_in,  none_in,    initial,   get_dmode_func,   dmode_help),
        (&#34;ihave&#34;,   all_in,  none_in,    initial,   get_ihave_func,   ihave_help),
        (&#34;ihost&#34;,   all_in,  none_in,    initial,   get_ihost_func,   ihost_help),
        (&#34;rlist&#34;,    all_in,  none_in,   auth_pass, get_rlist_func,   rlist_help),
        (&#34;rcount&#34;,   all_in,  none_in,   auth_pass, get_rcount_func,  rcount_help),
        (&#34;rsize&#34;,    all_in,  none_in,   auth_pass, get_rsize_func,   rsize_help),
        (&#34;rget&#34;,     all_in,  none_in,   auth_pass, get_rget_func,    rget_help),
        (&#34;rabs&#34;,     all_in,  none_in,   auth_pass, get_rabs_func,    rabs_help),
        (&#34;rhave&#34;,    all_in,  none_in,   auth_pass, get_rhave_func,   rhave_help),
        (&#34;rtest&#34;,    all_in,  none_in,   auth_pass, get_rtest_func, rtest_help),

        # The two factor auth commands. 2FA not required during development
        (&#34;rput&#34;,     all_in,  none_in,   minauth,   get_rput_func,   rput_help),
        (&#34;rcheck&#34;,   all_in,  none_in,   minauth,   get_rcheck_func, rcheck_help),
    ]
# ------------------------------------------------------------------------

class StateHandler():

    def __init__(self, resp):

        # Fill in class globals
        self.curr_state = initial
        self.resp = resp
        self.resp.fh = None
        self.badpass = 0
        self.wr = pywrap.wrapper()
        self.pb = pyvpacker.packbin()
        self.wr.pgdebug = 0
        self.buffsize = pyservsup.buffsize
        self.lockname = &#34;lock.lock&#34;
        self.fpx = None

    def waitlock(self):
        while True:
            if os.path.isfile(self.lockname):
                time.sleep(1)
            else:
                break
        try:
            self.fpx = open(self.lockname, &#34;wb&#34;)
            if fcntl:
                fcntl.lockf(self.fpx, fcntl.LOCK_EX)
        except:
            print(sys.exc_info())
            pass

    def dellock(self):
        if fcntl:
            fcntl.lockf(self.fpx, fcntl.LOCK_EX)
        try:
            self.fpx.close()
            os.unlink(self.lockname)
        except:
            print(sys.exc_info())
            pass

    # --------------------------------------------------------------------
    # This is the function where outside stimulus comes in.
    # All the workings of the state protocol are handled here.
    # Return True from handlers to signal session terminate request

    def run_state(self, strx):

        # ------------------------------------------------------
        ret = False
        try:
            ret = self._run_state_worker(strx)
        except:
            #print(&#34;last:&#34;, support.exc_last())
            support.put_exception(&#34;run state() = &#34; + str(self.curr_state) + &#34;:&#34;)
            sss =  [ERR, &#34;on processing request.&#34;, str(sys.exc_info()[1]), ]
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            ret = False
        # ------------------------------------------------------

        return ret

    def _run_state_worker(self, strx):
        got = False; ret = False

        #if self.pgdebug &gt; 8:
        #    print( &#34;Incoming strx: \n&#34;, crysupp.hexdump(strx, len(strx)))

        dstr = &#34;&#34;
        try:
            dstr = self.wr.unwrap_data(self.resp.ekey, strx)
        except:
            support.put_exception(&#34;While in _run state(): &#34;\
                                         + str(self.curr_state))
            sss =  ERR, &#34;cannot unwrap / decode data.&#34; #, strx
            #print(&#34;pyvstate.py %s&#34; % (sss,));
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            return False

        if self.pgdebug &gt; 6:
            #print( &#34;Incoming data:&#34;)
            for aa in dstr[1]:
                print(&#34;Incoming:&#34;, aa)

        comx = dstr[1] #.split()

        if self.pgdebug &gt; 3:
            print( &#34;Com:&#34;, &#34;&#39;&#34; + comx[0] + &#34;&#39;&#34;, &#34;State =&#34;, self.curr_state)

        got = False; comok = False

        # Scan the state table, execute actions, set new states
        for aa in state_table:
            # Command match
            if comx[0] == aa[0]:
                comok = True
                #if self.pgdebug &gt; 3:
                #    print(&#34;Found command, executing:&#34;, aa[0])

                # See if command is in state or all_in is in effect
                # or auth_in and stat &gt; auth is in effect -- use early out
                if aa[3] == none_in or aa[3] &lt;= self.curr_state:
                    cond = aa[1] == self.curr_state
                    if not cond:
                        cond = aa[1] == auth_in and self.curr_state &gt;= in_idle
                    if not cond:
                        cond = aa[1] == all_in

                    if cond:
                        # Auth?
                        if aa[3] &lt;= self.curr_state:
                            #print(aa[0], self.curr_state)
                            # Execute relevant function
                            ret2 = aa[4](self, comx)
                            #print(&#34;exec&#34;, ret2, aa[3], comx[0])
                            # Only set state if not all_in / auth_in
                            if not ret2 and aa[2] != none_in:
                                self.curr_state = aa[2]
                            got = True
                            if comx[0] == &#34;pass&#34;:
                                if ret2:
                                    self.badpass += 1
                            elif comx[0] == &#34;twofa&#34;:
                                if ret2:
                                    self.badpass += 1
                            else:
                                # Non pass command can terminate
                                ret = ret2

                            if self.badpass &gt; 2:
                                ret = True
                break

        # Not found in the state table for the current state, complain
        if not got:
            #print( &#34;Invalid command or out of sequence command &#34;, &#34;&#39;&#34; + comx[0] + &#34;&#39;&#34;)
            if not comok:
                sss =  [&#34;ERR&#34;, &#34;Invalid command issued&#34;,  comx[0]]
            else:
                sss =  [&#34;ERR&#34;, &#34;Out of Sequence command issued&#34;, comx[0]]
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            # Do not quit, just signal the error
            ret = False
        return ret

    def __del(self):
        print(&#34;del state handler&#34;)
# EOF</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="pyvstate.init_state_table"><code class="name flex">
<span>def <span class="ident">init_state_table</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init_state_table():

    global state_table
    #print(&#34;pystate init table&#34;)
    # This is to develop without entering auth code every time
    if not pyservsup.globals.conf.pmode:
        minauth =  auth_pass
    else:
        minauth =  auth_twofa

    state_table = \
    [
        # Command; start_state; end_state; min_auth; action func;  help func
        (&#34;ver&#34;,     all_in,  none_in,    initial,   get_ver_func,     vers_help),
        (&#34;id&#34;,      all_in,  none_in,    initial,   get_id_func,      id_help),
        (&#34;hello&#34;,   all_in,  none_in,    initial,   get_hello_func,   hello_help),
        (&#34;helo&#34;,    all_in,  none_in,    initial,   get_hello_func,   hello_help),
        (&#34;quit&#34;,    all_in,  none_in,    initial,   get_exit_func,    quit_help),
        (&#34;exit&#34;,    all_in,  none_in,    initial,   get_exit_func,    exit_help),
        (&#34;help&#34;,    all_in,  none_in,    initial,   get_help_func,    help_help),
        (&#34;akey&#34;,    all_in,  none_in,    initial,   get_akey_func,    akey_help),
        (&#34;uini&#34;,    all_in,  none_in,    initial,   get_uini_func,    uini_help),
        (&#34;user&#34;,    all_in,  none_in,    initial,   get_user_func,    user_help),
        (&#34;pass&#34;,    all_in,  auth_pass,  initial,   get_pass_func,    pass_help),
        (&#34;logout&#34;,  all_in,  initial,    auth_pass, get_lout_func,    logout_help),
        (&#34;sess&#34;,    all_in,  none_in,    initial,   get_sess_func,    sess_help),
        (&#34;tout&#34;,    all_in,  none_in,    initial,   get_tout_func,    tout_help),
        (&#34;qr&#34;,      all_in,  none_in,    initial,   get_qr_func,      qr_help),
        (&#34;chpass&#34;,  all_in,  none_in,    auth_pass, get_chpass_func,  chpass_help),
        (&#34;file&#34;,    all_in,  none_in,    auth_pass, put_file_func,    file_help),
        (&#34;mkdir&#34;,   all_in,  none_in,    auth_pass, get_mkdir_func,   mkdir_help),
        (&#34;rmdir&#34;,   all_in,  none_in,    auth_pass, get_rmdir_func,   rmdir_help),
        (&#34;data&#34;,    all_in,  none_in,    auth_pass, put_data_func,    data_help),
        (&#34;fget&#34;,    all_in,  none_in,    auth_pass, get_fget_func,    fget_help),
        (&#34;fput&#34;,    all_in,  none_in,    auth_pass, get_fput_func,    fput_help),
        (&#34;del&#34;,     all_in,  none_in,    auth_pass, get_del_func,     del_help),
        (&#34;uadd&#34;,    all_in,  none_in,    auth_pass, get_uadd_func,    uadd_help),
        (&#34;udel&#34;,    all_in,  none_in,    auth_pass, get_udel_func,    udel_help),
        (&#34;uena&#34;,    all_in,  none_in,    auth_pass, get_uena_func,    uena_help),
        (&#34;ulist&#34;,   all_in,  none_in,    auth_pass, get_ulist_func,   ulist_help),
        (&#34;aadd&#34;,    all_in,  none_in,    auth_pass, get_aadd_func,    aadd_help),
        (&#34;ls&#34;,      all_in,  none_in,    auth_pass, get_ls_func,      lsls_help),
        (&#34;dir&#34;,     all_in,  none_in,    auth_pass, get_ls_func,      lsls_help),
        (&#34;lsd&#34;,     all_in,  none_in,    auth_pass, get_lsd_func,     lsld_help),
        (&#34;cd&#34;,      all_in,  none_in,    auth_pass, get_cd_func,      cdcd_help),
        (&#34;pwd&#34;,     all_in,  none_in,    auth_pass, get_pwd_func,     pwdd_help),
        (&#34;stat&#34;,    all_in,  none_in,    auth_pass, get_stat_func,    stat_help),
        (&#34;buff&#34;,    all_in,  none_in,    auth_pass, get_buff_func,    buff_help),
        (&#34;throt&#34;,   all_in,  none_in,    auth_pass, get_throt_func,   throt_help),
        (&#34;twofa&#34;,   all_in,  auth_twofa, auth_pass, get_twofa_func,   twofa_help),
        (&#34;dmode&#34;,   all_in,  none_in,    initial,   get_dmode_func,   dmode_help),
        (&#34;ihave&#34;,   all_in,  none_in,    initial,   get_ihave_func,   ihave_help),
        (&#34;ihost&#34;,   all_in,  none_in,    initial,   get_ihost_func,   ihost_help),
        (&#34;rlist&#34;,    all_in,  none_in,   auth_pass, get_rlist_func,   rlist_help),
        (&#34;rcount&#34;,   all_in,  none_in,   auth_pass, get_rcount_func,  rcount_help),
        (&#34;rsize&#34;,    all_in,  none_in,   auth_pass, get_rsize_func,   rsize_help),
        (&#34;rget&#34;,     all_in,  none_in,   auth_pass, get_rget_func,    rget_help),
        (&#34;rabs&#34;,     all_in,  none_in,   auth_pass, get_rabs_func,    rabs_help),
        (&#34;rhave&#34;,    all_in,  none_in,   auth_pass, get_rhave_func,   rhave_help),
        (&#34;rtest&#34;,    all_in,  none_in,   auth_pass, get_rtest_func, rtest_help),

        # The two factor auth commands. 2FA not required during development
        (&#34;rput&#34;,     all_in,  none_in,   minauth,   get_rput_func,   rput_help),
        (&#34;rcheck&#34;,   all_in,  none_in,   minauth,   get_rcheck_func, rcheck_help),
    ]</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="pyvstate.StateHandler"><code class="flex name class">
<span>class <span class="ident">StateHandler</span></span>
<span>(</span><span>resp)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class StateHandler():

    def __init__(self, resp):

        # Fill in class globals
        self.curr_state = initial
        self.resp = resp
        self.resp.fh = None
        self.badpass = 0
        self.wr = pywrap.wrapper()
        self.pb = pyvpacker.packbin()
        self.wr.pgdebug = 0
        self.buffsize = pyservsup.buffsize
        self.lockname = &#34;lock.lock&#34;
        self.fpx = None

    def waitlock(self):
        while True:
            if os.path.isfile(self.lockname):
                time.sleep(1)
            else:
                break
        try:
            self.fpx = open(self.lockname, &#34;wb&#34;)
            if fcntl:
                fcntl.lockf(self.fpx, fcntl.LOCK_EX)
        except:
            print(sys.exc_info())
            pass

    def dellock(self):
        if fcntl:
            fcntl.lockf(self.fpx, fcntl.LOCK_EX)
        try:
            self.fpx.close()
            os.unlink(self.lockname)
        except:
            print(sys.exc_info())
            pass

    # --------------------------------------------------------------------
    # This is the function where outside stimulus comes in.
    # All the workings of the state protocol are handled here.
    # Return True from handlers to signal session terminate request

    def run_state(self, strx):

        # ------------------------------------------------------
        ret = False
        try:
            ret = self._run_state_worker(strx)
        except:
            #print(&#34;last:&#34;, support.exc_last())
            support.put_exception(&#34;run state() = &#34; + str(self.curr_state) + &#34;:&#34;)
            sss =  [ERR, &#34;on processing request.&#34;, str(sys.exc_info()[1]), ]
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            ret = False
        # ------------------------------------------------------

        return ret

    def _run_state_worker(self, strx):
        got = False; ret = False

        #if self.pgdebug &gt; 8:
        #    print( &#34;Incoming strx: \n&#34;, crysupp.hexdump(strx, len(strx)))

        dstr = &#34;&#34;
        try:
            dstr = self.wr.unwrap_data(self.resp.ekey, strx)
        except:
            support.put_exception(&#34;While in _run state(): &#34;\
                                         + str(self.curr_state))
            sss =  ERR, &#34;cannot unwrap / decode data.&#34; #, strx
            #print(&#34;pyvstate.py %s&#34; % (sss,));
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            return False

        if self.pgdebug &gt; 6:
            #print( &#34;Incoming data:&#34;)
            for aa in dstr[1]:
                print(&#34;Incoming:&#34;, aa)

        comx = dstr[1] #.split()

        if self.pgdebug &gt; 3:
            print( &#34;Com:&#34;, &#34;&#39;&#34; + comx[0] + &#34;&#39;&#34;, &#34;State =&#34;, self.curr_state)

        got = False; comok = False

        # Scan the state table, execute actions, set new states
        for aa in state_table:
            # Command match
            if comx[0] == aa[0]:
                comok = True
                #if self.pgdebug &gt; 3:
                #    print(&#34;Found command, executing:&#34;, aa[0])

                # See if command is in state or all_in is in effect
                # or auth_in and stat &gt; auth is in effect -- use early out
                if aa[3] == none_in or aa[3] &lt;= self.curr_state:
                    cond = aa[1] == self.curr_state
                    if not cond:
                        cond = aa[1] == auth_in and self.curr_state &gt;= in_idle
                    if not cond:
                        cond = aa[1] == all_in

                    if cond:
                        # Auth?
                        if aa[3] &lt;= self.curr_state:
                            #print(aa[0], self.curr_state)
                            # Execute relevant function
                            ret2 = aa[4](self, comx)
                            #print(&#34;exec&#34;, ret2, aa[3], comx[0])
                            # Only set state if not all_in / auth_in
                            if not ret2 and aa[2] != none_in:
                                self.curr_state = aa[2]
                            got = True
                            if comx[0] == &#34;pass&#34;:
                                if ret2:
                                    self.badpass += 1
                            elif comx[0] == &#34;twofa&#34;:
                                if ret2:
                                    self.badpass += 1
                            else:
                                # Non pass command can terminate
                                ret = ret2

                            if self.badpass &gt; 2:
                                ret = True
                break

        # Not found in the state table for the current state, complain
        if not got:
            #print( &#34;Invalid command or out of sequence command &#34;, &#34;&#39;&#34; + comx[0] + &#34;&#39;&#34;)
            if not comok:
                sss =  [&#34;ERR&#34;, &#34;Invalid command issued&#34;,  comx[0]]
            else:
                sss =  [&#34;ERR&#34;, &#34;Out of Sequence command issued&#34;, comx[0]]
            self.resp.datahandler.putencode(sss, self.resp.ekey)
            # Do not quit, just signal the error
            ret = False
        return ret

    def __del(self):
        print(&#34;del state handler&#34;)</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="pyvstate.StateHandler.dellock"><code class="name flex">
<span>def <span class="ident">dellock</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def dellock(self):
    if fcntl:
        fcntl.lockf(self.fpx, fcntl.LOCK_EX)
    try:
        self.fpx.close()
        os.unlink(self.lockname)
    except:
        print(sys.exc_info())
        pass</code></pre>
</details>
</dd>
<dt id="pyvstate.StateHandler.run_state"><code class="name flex">
<span>def <span class="ident">run_state</span></span>(<span>self, strx)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run_state(self, strx):

    # ------------------------------------------------------
    ret = False
    try:
        ret = self._run_state_worker(strx)
    except:
        #print(&#34;last:&#34;, support.exc_last())
        support.put_exception(&#34;run state() = &#34; + str(self.curr_state) + &#34;:&#34;)
        sss =  [ERR, &#34;on processing request.&#34;, str(sys.exc_info()[1]), ]
        self.resp.datahandler.putencode(sss, self.resp.ekey)
        ret = False
    # ------------------------------------------------------

    return ret</code></pre>
</details>
</dd>
<dt id="pyvstate.StateHandler.waitlock"><code class="name flex">
<span>def <span class="ident">waitlock</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def waitlock(self):
    while True:
        if os.path.isfile(self.lockname):
            time.sleep(1)
        else:
            break
    try:
        self.fpx = open(self.lockname, &#34;wb&#34;)
        if fcntl:
            fcntl.lockf(self.fpx, fcntl.LOCK_EX)
    except:
        print(sys.exc_info())
        pass</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="pyvstate.init_state_table" href="#pyvstate.init_state_table">init_state_table</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="pyvstate.StateHandler" href="#pyvstate.StateHandler">StateHandler</a></code></h4>
<ul class="">
<li><code><a title="pyvstate.StateHandler.dellock" href="#pyvstate.StateHandler.dellock">dellock</a></code></li>
<li><code><a title="pyvstate.StateHandler.run_state" href="#pyvstate.StateHandler.run_state">run_state</a></code></li>
<li><code><a title="pyvstate.StateHandler.waitlock" href="#pyvstate.StateHandler.waitlock">waitlock</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>