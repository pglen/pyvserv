<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>pyvcli_sess_tout API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>pyvcli_sess_tout</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#!/usr/bin/env python3

from __future__ import print_function

# ------------------------------------------------------------------------
# Test client for the pyserv project. Encrypt test.

import  os, sys, getopt, signal, select, socket, time, struct
import  random, stat

from Crypto.Hash import SHA512
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_v1_5
from Crypto.PublicKey import RSA
from Crypto.Hash import SHA
from Crypto import Random

base = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(base,  &#39;..&#39; + os.sep + &#39;pyvcommon&#39;))

import support, pycrypt, pyservsup, pyclisup
import pysyslog, comline

&#39;&#39;&#39;
# test encrypt with large keys
rrr =  &#34;mTQdnL51eKnblQflLGSMvnMKDG4XjhKa9Mbgm5ZY9YLd&#34; \
        &#34;/SxqZZxwyKc/ZVzCVwMxiJ5X8LdX3X5VVO5zq/VBWQ==&#34;
sss = bluepy.encrypt(rrr, conf.sess_key)
ttt = bluepy.decrypt(sss, conf.sess_key)
print (rrr)
print (ttt)
&#39;&#39;&#39;

# ------------------------------------------------------------------------
# Functions from command line

def phelp():

    print()
    print( &#34;Usage: &#34; + os.path.basename(sys.argv[0]) + &#34; [options]&#34;)
    print()
    print( &#34;Options:    -d level  - Debug level 0-10&#34;)
    print( &#34;            -p port   - Port to use (default: 6666)&#34;)
    print( &#34;            -l level  - Log level (default: 0)&#34;)
    print( &#34;            -c file   - Save comm to file&#34;)
    print( &#34;            -s        - Showkey&#34;)
    print( &#34;            -v        - Verbose&#34;)
    print( &#34;            -q        - Quiet&#34;)
    print( &#34;            -h        - Help&#34;)
    #print( &#34; Needs debug level or verbose to have any output.&#34;)
    print()
    sys.exit(0)

def pversion():
    print( os.path.basename(sys.argv[0]), &#34;Version&#34;, support.version)
    sys.exit(0)

    # option, var_name, initial_val, function
optarr = \
    [&#34;d:&#34;,  &#34;pgdebug&#34;,  0,      None],      \
    [&#34;p:&#34;,  &#34;port&#34;,     6666,   None],      \
    [&#34;c:&#34;,  &#34;comm&#34;,     &#34;&#34;,     None],      \
    [&#34;v&#34;,   &#34;verbose&#34;,  0,      None],      \
    [&#34;q&#34;,   &#34;quiet&#34;,    0,      None],      \
    [&#34;s&#34;,   &#34;showkey&#34;,  &#34;&#34;,     None],      \
    [&#34;t&#34;,   &#34;test&#34;,     &#34;x&#34;,    None],      \
    [&#34;V&#34;,   None,       None,   pversion],  \
    [&#34;h&#34;,   None,       None,   phelp]      \

conf = comline.Config(optarr)

# ------------------------------------------------------------------------

if __name__ == &#39;__main__&#39;:

    args = conf.comline(sys.argv[1:])

    if conf.comm:
        print(&#34;Save to filename&#34;, conf.comm)

    pyclisup.verbose = conf.verbose
    pyclisup.pgdebug = conf.pgdebug

    if len(args) == 0:
        ip = &#39;127.0.0.1&#39;
    else:
        ip = args[0]

    hand = pyclisup.CliSup()
    hand.verbose = conf.verbose
    hand.pgdebug = conf.pgdebug
    hand.comm  = conf.comm

    try:
        respc = hand.connect(ip, conf.port)
    except:
        print( &#34;Cannot connect to:&#34;, ip + &#34;:&#34; + str(conf.port), sys.exc_info()[1])
        sys.exit(1)

    #print(&#34;IP:&#34;, ip, respc);
    #print(&#34;Initial:&#34;, respc);

    resp = hand.client([&#34;akey&#34;])
    #print(&#34;akey response&#34;, resp)

    if resp[0] != &#34;OK&#34;:
        print(&#34;Error on getting key:&#34;, resp[1])
        hand.client([&#34;quit&#34;])
        hand.close();
        sys.exit(0)

    if conf.verbose:
        print(&#34;Got akey hash:&#34;, &#34;&#39;&#34; + resp[1] + &#34;&#39;&#34;)
        pass

    #if conf.pgdebug &gt; 4:
    #    print (&#34;Server response2:\n&#34; +  &#34;&#39;&#34; + resp[1].decode(&#34;cp437&#34;) +  &#34;&#39;\n&#34;)

    hhh = SHA512.new();
    hhh.update(resp[2])
    #hhh.update(bytes(resp[2], &#34;cp437&#34;))

    if conf.pgdebug &gt; 3:
        print(&#34;Hash1:  &#39;&#34; + resp[1] + &#34;&#39;&#34;)
        print(&#34;Hash2:  &#39;&#34; + hhh.hexdigest() + &#34;&#39;&#34;)

    # Remember key
    if hhh.hexdigest() !=  resp[1]:
        print(&#34;Tainted key, aborting.&#34;)
        hand.client([&#34;quit&#34;])
        hand.close();
        sys.exit(0)

    hand.pkey = resp[2]

    #if conf.quiet == False:
    #     print(&#34;Key response:&#34;, resp[0], resp[2][:32], &#34;...&#34;)

    if conf.pgdebug &gt; 4:
         print(hand.pkey)

    if conf.pgdebug &gt; 2:
        print (&#34;Server response:&#34;, &#34;&#39;&#34; + hhh.hexdigest() + &#34;&#39;&#34;)

    if conf.showkey or conf.pgdebug &gt; 5:
        #print(&#34;Key:&#34;)
        print(hand.pkey)

    try:
        hand.pubkey = RSA.importKey(hand.pkey)
        if conf.pgdebug &gt; 4:
            print (hand.pubkey)
    except:
        print(&#34;Cannot import public key.&#34;)
        support.put_exception(&#34;import key&#34;)
        hand.client([&#34;quit&#34;])
        hand.close();
        sys.exit(0)

    resp0 = hand.client([&#34;hello&#34;,], )
    print(&#34;Hello (unencrypted) Response:&#34;, resp0[1])

    #if conf.pgdebug &gt; 1:
    #    print(&#34;Got pub key&#34;, hand.pubkey, &#34;size =&#34;, hand.pubkey.size_in_bits())

    # Generate communication key
    conf.sess_key = Random.new().read(512)
    sss = SHA512.new(); sss.update(conf.sess_key)

    cipher = PKCS1_v1_5.new(hand.pubkey)
    #print (&#34;cipher&#34;, cipher.can_encrypt())

    if conf.pgdebug &gt; 2:
        support.shortdump(&#34;conf.sess_key&#34;, conf.sess_key )

    sess_keyx = cipher.encrypt(conf.sess_key)
    ttt = SHA512.new(); ttt.update(sess_keyx)

    if conf.pgdebug &gt; 2:
        support.shortdump(&#34;sess_keyx&#34;, sess_keyx )

    resp3 = hand.client([&#34;sess&#34;, sss.hexdigest(), ttt.hexdigest(), sess_keyx], &#34;&#34;, False)
    #print(&#34;Sess Response:&#34;, resp3)

    if resp3[0] != &#34;OK&#34;:
        print(&#34;Error on setting session:&#34;, resp3[1])
        hand.client([&#34;quit&#34;])
        hand.close();
        sys.exit(0)

    # Make a note of the session key
    #print(resp3[1])
    support.shortdump(&#34; All is encrypted with&#34;, conf.sess_key )

    # Session estabilished, try a simple command
    resp4 = hand.client([&#34;hello&#34;,], conf.sess_key)
    print(&#34;Hello (encrypted) Response:&#34;, resp4[1])

    # --------------------------------------------------------------------
    # Generate communication key, second session and second run

    conf.sess_key2 = Random.new().read(512)
    sss2 = SHA512.new(); sss2.update(conf.sess_key2)

    #cipher = PKCS1_v1_5.new(hand.pubkey)
    #print (&#34;cipher&#34;, cipher.can_encrypt())

    if conf.pgdebug &gt; 2:
        support.shortdump(&#34;conf.sess_key2&#34;, conf.sess_key2 )

    sess_keyx2 = cipher.encrypt(conf.sess_key2)
    ttt2 = SHA512.new(); ttt2.update(sess_keyx2)

    if conf.pgdebug &gt; 2:
        support.shortdump(&#34;sess_keyx&#34;, sess_keyx )

    #print(&#34;Key Hexdigest&#34;, ttt2.hexdigest()[:16])

    resp4 = hand.client([&#34;sess&#34;, sss2.hexdigest(), ttt2.hexdigest(), sess_keyx2],
                                conf.sess_key, False)

    if resp4[0] != &#34;OK&#34;:
        print(&#34;Err: &#34;, resp4)
        cresp = hand.client([&#34;quit&#34;, ], conf.sess_key)
        print (&#34;Server quit response:&#34;, cresp)
        sys.exit(0)

    # Make a note of the session key
    #print(resp4[1])
    support.shortdump(&#34; All is encrypted with&#34;, conf.sess_key2 )

    # Session estabilished, try a simple command
    resp5 = hand.client([&#34;hello&#34;,], conf.sess_key2)
    print(&#34;Hello (encrypted2) Response:&#34;, resp5)

    time.sleep(10)

    resp5 = hand.client([&#34;hello&#34;,], conf.sess_key2)
    print(&#34;Hello (encrypted2) Response:&#34;, resp5)

    hand.client([&#34;quit&#34;,],conf.sess_key2)
    hand.close();

    sys.exit(0)

# EOF</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="pyvcli_sess_tout.phelp"><code class="name flex">
<span>def <span class="ident">phelp</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def phelp():

    print()
    print( &#34;Usage: &#34; + os.path.basename(sys.argv[0]) + &#34; [options]&#34;)
    print()
    print( &#34;Options:    -d level  - Debug level 0-10&#34;)
    print( &#34;            -p port   - Port to use (default: 6666)&#34;)
    print( &#34;            -l level  - Log level (default: 0)&#34;)
    print( &#34;            -c file   - Save comm to file&#34;)
    print( &#34;            -s        - Showkey&#34;)
    print( &#34;            -v        - Verbose&#34;)
    print( &#34;            -q        - Quiet&#34;)
    print( &#34;            -h        - Help&#34;)
    #print( &#34; Needs debug level or verbose to have any output.&#34;)
    print()
    sys.exit(0)</code></pre>
</details>
</dd>
<dt id="pyvcli_sess_tout.pversion"><code class="name flex">
<span>def <span class="ident">pversion</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def pversion():
    print( os.path.basename(sys.argv[0]), &#34;Version&#34;, support.version)
    sys.exit(0)

    # option, var_name, initial_val, function</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="pyvcli_sess_tout.phelp" href="#pyvcli_sess_tout.phelp">phelp</a></code></li>
<li><code><a title="pyvcli_sess_tout.pversion" href="#pyvcli_sess_tout.pversion">pversion</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>